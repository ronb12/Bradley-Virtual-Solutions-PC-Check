<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bradley Virtual Solutions PC Check</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    .container { max-width: 800px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background: #fff; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    select, button { margin: 10px 0; padding: 10px; width: 100%; }
    .tooltip { font-size: 0.9em; color: #555; margin-top: -8px; margin-bottom: 10px; }
    .result { margin-top: 20px; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 10px; text-align: left; }
    .pass { background-color: #d4edda; color: #155724; }
    .fail { background-color: #f8d7da; color: #721c24; }
    .success-message { margin-top: 20px; padding: 15px; background-color: #d4edda; color: #155724; border-radius: 5px; }
    #speedStatus { margin-top: 15px; font-weight: bold; color: #333; }
    #progressBar { width: 100%; background-color: #eee; height: 10px; margin-top: 5px; border-radius: 5px; overflow: hidden; }
    #progressFill { height: 100%; width: 0%; background-color: #4caf50; transition: width 0.3s ease-in-out; }
  </style>
</head>
<body onload="autoDetectSystemInfo()">
  <div class="container">
    <h2>Bradley Virtual Solutions PC Check</h2>
    <form id="compatibilityForm">
      <label for="latency">Network Latency (ms):</label>
      <select id="latency">
        <option value="">Select Latency</option>
        <option value="120">120 ms or lower</option>
        <option value="Higher">Higher than 120 ms</option>
      </select>
      <div class="tooltip">✅ Auto-detected on page load</div>

      <label for="downloadSpeed">Download Speed:</label>
      <select id="downloadSpeed">
        <option value="">Select Speed</option>
        <option value="10">10 Mbps or higher</option>
        <option value="Lower">Lower than 10 Mbps</option>
      </select>

      <label for="uploadSpeed">Upload Speed:</label>
      <select id="uploadSpeed">
        <option value="">Select Speed</option>
        <option value="3">3 Mbps or higher</option>
        <option value="Lower">Lower than 3 Mbps</option>
      </select>

      <button type="button" onclick="autoDetectSystemInfo()">🔄 Auto-Detect System Info</button>
      <button type="button" onclick="runSpeedTest()">🚀 Run Download Speed Test</button>
      <button type="button" onclick="runRealUploadTest()">📤 Run Upload Speed Test</button>
      <div id="speedStatus">Click a test button to begin.</div>
      <div id="progressBar"><div id="progressFill"></div></div>

      <button type="button" onclick="checkCompatibility()">✅ Check Compatibility</button>
    </form>
    <div id="result" class="result"></div>
  </div>

  <script>
    function autoDetectSystemInfo() {
      const ua = navigator.userAgent.toLowerCase();
      let os = "Other";
      if (ua.includes("windows nt 10.0")) os = "Windows 10";
      else if (ua.includes("windows nt 6.3")) os = "Windows 8.1";
      else if (ua.includes("macintosh")) os = "macOS";
      else if (ua.includes("linux")) os = "Linux";
      document.getElementById("os")?.value = os;

      const ram = navigator.deviceMemory || 0;
      if (ram > 0) {
        const ramOption = ram >= 32 ? "32" : ram >= 16 ? "16" : ram >= 8 ? "8" : "4";
        document.getElementById("ram")?.value = ramOption;
      }

      const resolution = screen.width >= 1280 && screen.height >= 1024 ? "1280x1024" : "Lower";
      document.getElementById("monitorResolution")?.value = resolution;

      if ('connection' in navigator && navigator.connection.type) {
        const type = navigator.connection.type;
        if (type === "ethernet") {
          document.getElementById("wiredInternet")?.value = "Yes";
        } else if (type === "wifi") {
          document.getElementById("wiredInternet")?.value = "No";
        }
      }

      autoDetectLatency(); // 🔥 Run latency detection
    }

    async function autoDetectLatency() {
      const latencyField = document.getElementById("latency");
      const start = performance.now();
      try {
        await fetch("https://1.1.1.1/cdn-cgi/trace", { mode: "no-cors" });
        const end = performance.now();
        const latency = Math.round(end - start);
        const latencyValue = latency <= 120 ? "120" : "Higher";
        latencyField.value = latencyValue;
        console.log(`🛰️ Latency detected: ${latency}ms`);
      } catch {
        latencyField.value = "";
        console.warn("⚠️ Latency detection failed.");
      }
    }

    async function runSpeedTest() {
      const downloadElement = document.getElementById("downloadSpeed");
      const speedStatus = document.getElementById("speedStatus");
      const progressFill = document.getElementById("progressFill");

      const updateProgress = (percent, message) => {
        progressFill.style.width = percent + "%";
        if (message) speedStatus.textContent = message;
      };

      try {
        updateProgress(0, "⏳ Testing download speed...");
        const testUrl = "https://upload.wikimedia.org/wikipedia/commons/3/3c/Shaki_waterfall.jpg";
        const startTime = new Date().getTime();
        const response = await fetch(testUrl, { cache: "no-cache" });
        const endTime = new Date().getTime();

        updateProgress(60, "📈 Calculating download speed...");
        if (!response.ok) throw new Error("Download failed");

        const duration = (endTime - startTime) / 1000;
        const fileSize = 1048576;
        const speedMbps = ((fileSize * 8) / duration) / 1_000_000;

        const downloadValue = speedMbps >= 10 ? "10" : "Lower";
        downloadElement.value = downloadValue;

        updateProgress(100, `✅ Download Speed: ${speedMbps.toFixed(2)} Mbps`);
        setTimeout(() => {
          progressFill.style.width = "0%";
          speedStatus.textContent = "Click a test button to retest.";
        }, 4000);
      } catch (err) {
        updateProgress(0, "❌ Download test failed.");
      }
    }

    async function runRealUploadTest() {
      const uploadElement = document.getElementById("uploadSpeed");
      const speedStatus = document.getElementById("speedStatus");
      const progressFill = document.getElementById("progressFill");

      const updateProgress = (percent, message) => {
        progressFill.style.width = percent + "%";
        if (message) speedStatus.textContent = message;
      };

      try {
        updateProgress(0, "📤 Uploading 1MB test file...");
        const blob = new Blob([new Uint8Array(1024 * 1024)], { type: "application/octet-stream" });

        const startTime = new Date().getTime();
        const response = await fetch("https://httpbin.org/post", {
          method: "POST",
          body: blob
        });
        const endTime = new Date().getTime();

        updateProgress(60, "📈 Calculating upload speed...");
        if (!response.ok) throw new Error("Upload failed");

        const duration = (endTime - startTime) / 1000;
        const uploadMbps = ((blob.size * 8) / duration) / 1_000_000;

        const uploadValue = uploadMbps >= 3 ? "3" : "Lower";
        uploadElement.value = uploadValue;

        updateProgress(100, `✅ Upload Speed: ${uploadMbps.toFixed(2)} Mbps`);
        setTimeout(() => {
          progressFill.style.width = "0%";
          speedStatus.textContent = "Click a test button to retest.";
        }, 4000);
      } catch (err) {
        updateProgress(0, "❌ Upload test failed.");
      }
    }

    function checkCompatibility() {
      autoDetectSystemInfo();
      const ids = ["latency", "downloadSpeed", "uploadSpeed"];
      const specs = Object.fromEntries(ids.map(id => [id, document.getElementById(id)?.value]));

      const results = [
        { feature: "Latency", value: specs.latency, requirement: "120 ms or lower", result: specs.latency === "120" ? "✅ Pass" : "❌ Fail" },
        { feature: "Download Speed", value: specs.downloadSpeed, requirement: "10 Mbps or higher", result: specs.downloadSpeed === "10" ? "✅ Pass" : "❌ Fail" },
        { feature: "Upload Speed", value: specs.uploadSpeed, requirement: "3 Mbps or higher", result: specs.uploadSpeed === "3" ? "✅ Pass" : "❌ Fail" }
      ];

      const allPass = results.every(r => r.result === "✅ Pass");
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = `
        <table>
          <thead><tr><th>Feature</th><th>Value</th><th>Requirement</th><th>Pass/Fail</th></tr></thead>
          <tbody>
            ${results.map(r => `<tr><td>${r.feature}</td><td>${r.value || "Not selected"}</td><td>${r.requirement}</td><td class="${r.result.includes("Pass") ? "pass" : "fail"}">${r.result}</td></tr>`).join("")}
          </tbody>
        </table>
        ${allPass ? `<div class="success-message">✅ Congratulations! Your system meets all the requirements.</div>` : ""}
      `;
    }
  </script>
</body>
</html>
